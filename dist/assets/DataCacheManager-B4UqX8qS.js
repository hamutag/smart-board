const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-B66Lor28.js","assets/index-CRLMMQZq.css"])))=>i.map(i=>d[i]);
import{_ as l}from"./index-B66Lor28.js";const r="smartboard:dataCache:v2";class c{constructor(){this.cache={settings:null,dailyZmanim:null,announcements:null,niftarim:null,refuah:null,halachot:null,brachot:null,leiluyNishmat:null,communityGallery:null,communityMessages:null,shabbatTimes:null,slideSettings:null,boardSchedule:null,chizukYomi:null},this.loading=!1,this.lastLoadTime=null,this.subscribers=new Set,this.REFRESH_INTERVAL=7200*1e3,typeof window<"u"&&(this.loadFromStorage(),this.lastLoadTime&&(this.notifySubscribers(),this.scheduleRefresh()))}subscribe(t){return this.subscribers.add(t),()=>this.subscribers.delete(t)}notifySubscribers(){this.subscribers.forEach(t=>t(this.cache))}isExpired(){return this.lastLoadTime?Date.now()-this.lastLoadTime>this.REFRESH_INTERVAL:!0}loadFromStorage(){try{const t=localStorage.getItem(r);if(!t)return!1;const a=JSON.parse(t);return!a||typeof a!="object"?!1:(a.cache&&typeof a.cache=="object"&&(this.cache={...this.cache,...a.cache}),this.lastLoadTime=Number(a.lastLoadTime)||null,!0)}catch{return!1}}saveToStorage(){try{localStorage.setItem(r,JSON.stringify({cache:this.cache,lastLoadTime:this.lastLoadTime}))}catch{}}async loadAllData(){if(this.loading)return this.cache;this.loading=!0,console.log("[DataCache] Loading all data...");try{const{base44:t}=await l(async()=>{const{base44:i}=await import("./index-B66Lor28.js").then(s=>s.b);return{base44:i}},__vite__mapDeps([0,1])),h=new Date().toISOString().split("T")[0],e=i=>new Promise(s=>setTimeout(s,i));this.cache.settings=await t.entities.Settings.list(),await e(150),this.cache.dailyZmanim=await t.entities.DailyZmanim.filter({date:h}),await e(150),this.cache.announcements=await t.entities.Announcement.filter({active:!0},"-priority"),await e(150),this.cache.niftarim=await t.entities.NiftarWeekly.filter({active:!0}),await e(150),this.cache.refuah=await t.entities.RefuahShelema.filter({active:!0},"priority"),await e(150),this.cache.halachot=await t.entities.Halacha.filter({active:!0},"order"),await e(150),this.cache.brachot=await t.entities.Bracha.filter({active:!0},"order"),await e(150),this.cache.leiluyNishmat=await t.entities.LeiluyNishmat.list("order"),await e(150),this.cache.communityGallery=await t.entities.CommunityGallery.filter({active:!0},"order"),await e(150),this.cache.communityMessages=await t.entities.CommunityMessage.filter({active:!0}),await e(150),this.cache.shabbatTimes=await t.entities.ShabbatTimes.filter({active:!0}),await e(150),this.cache.slideSettings=await t.entities.SlideSettings.list({sort:{updated_date:-1},limit:100}),await e(150),this.cache.boardSchedule=await t.entities.BoardSchedule.list(),await e(150),this.cache.chizukYomi=await t.entities.ChizukYomi.list("order"),this.lastLoadTime=Date.now(),this.saveToStorage(),console.log("[DataCache] All data loaded successfully at:",new Date().toLocaleTimeString()),this.notifySubscribers(),this.scheduleRefresh()}catch(t){console.error("[DataCache] Error loading data:",t)}finally{this.loading=!1}return this.cache}scheduleRefresh(){this.refreshTimer&&clearTimeout(this.refreshTimer);const t=this.lastLoadTime?Date.now()-this.lastLoadTime:this.REFRESH_INTERVAL,a=Math.max(this.REFRESH_INTERVAL-t,5*1e3);this.refreshTimer=setTimeout(()=>{console.log("[DataCache] Auto-refreshing data..."),this.loadAllData()},a)}getCache(){return this.cache}isLoaded(){return this.lastLoadTime!==null}async ensureLoaded(){return this.isLoaded()&&!this.isExpired()?(this.scheduleRefresh(),this.cache):this.isLoaded()&&this.isExpired()?(this.scheduleRefresh(),this.loadAllData().catch(()=>{}),this.cache):(this.loading||await this.loadAllData(),this.cache)}forceRefresh(){return this.loadAllData()}}const o=new c;typeof window<"u"&&o.ensureLoaded().catch(()=>{});export{o as dataCache};
